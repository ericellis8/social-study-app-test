var miaChat=function(){return{chatTabs:null,init:function(){this.setupTabs();this.addWelcomeTab();this.getBuddies()},setupTabs:function(){this.chatTabs=$("#tabs").tabs()},getChatTabs:function(){return this.chatTabs},addWelcomeTab:function(){miaChat.getChatTabs().tabs("add","#welcome","Welcome");var a='<div id="welcome-tab">'+$("#welcomeMessage").val()+"</div>";$("div#welcome.ui-tabs-panel").append(a)},getBuddies:function(){$.getJSON("getBuddies.php",function(a){$.each(a,function(e,j){var k=a[e].bid,g=a[e].username,c=a[e].full_name,f=a[e].heartbeat,h=a[e].status,d=$("#buddy"+k).length,l,b;if(typeof f==="undefined"||f===undefined||f===null){f=500}if(typeof h==="undefined"||h===undefined||h===null){if(f<120){h="online"}else{h="offline"}}if(d===0){l='<li class="'+h+'" id="buddy'+k+'"><a href="#" title="'+c+'">'+g+"</a></li>";$("#buddylist").append(l);$("#buddy"+k).bind("dblclick",{username:g},function(i){i.preventDefault();miaChat.resetDocumentTitle.call(miaChat,"");miaChat.startChat.call(miaChat,i.data.username,true)})}else{b=$("#buddy"+k).hasClass(h);if(b===false){$("#buddy"+k).removeClass();$("#buddy"+k).addClass(h)}}if(f>120||h==="offline"){$("#buddy"+k).fadeTo("slow",0.5)}else{$("#buddy"+k).fadeTo("slow",1)}})})},chatSubmit:function(){var a=$("#activeChat").val(),d=$("#"+a+"Input").val();$("#"+a+"Input").val("");if((a!=="")&&($.trim(d)!=="")){var c,b=new Date();c=dateFormat(b,"dddd, mmm d, h:MM TT");$.post("addMessage.php",{message:d,userto:a},function(f){var e=f,g,h;g='<ul><li class="messageHeaderOwner">Your Message ('+c+')</li><li class="messageBodyOwner">'+e+"</li></ul>";h=a+"Input";$("#"+a+"Inner").append(g);$("#"+a+"Inner ul li.messageBodyOwner a").attr("target","_blank");$("#"+a+"Input").attr("value","");miaChat.scrollToBottom(a+"Inner");$("#"+a+"Input")[0].focus()})}},scrollToBottom:function(b){var a=document.getElementById(b);a.scrollTop=a.scrollHeight},chatClose:function(a){a.preventDefault();$("ul.ui-tabs-nav > li > a").each(function(b){if((b!==0)&&($.trim($(this).text())===a.data.username)){$("#"+a.data.username+"Input").unbind("keyup");$("#"+a.data.username+"-close").unbind("click");miaChat.getChatTabs().tabs("remove",b)}})},startChat:function(c,a){if($("#"+c).length===0){miaChat.getChatTabs().tabs("add","#"+c,c+'&nbsp;<img id="'+c+'-close" class="tab-close" src="images/famfamfam_silk_icons/cancel.png" alt="close"/>');var b='<div id="'+c+'Inner" class="innerChatWindow"></div><div id="'+c+'Footer" class="containerFooter"><ul id="emoticon"><li><img class="emoButton" title="0-]" id="'+c+'_||_face_angel" src="images/tango/smiles/face-angel.png" alt="face-angel" /></li><li><img class="emoButton" title="8-(" id="'+c+'_||_face_crying" src="images/tango/smiles/face-crying.png" alt="face-crying" /></li><li><img class="emoButton" title="!)" id="'+c+'_||_face_devilish" src="images/tango/smiles/face-devilish.png" alt="face-devilish" /></li><li><img class="emoButton" title="8)" id="'+c+'_||_face_glasses" src="images/tango/smiles/face-glasses.png" alt="face-glasses" /></li><li><img class="emoButton" title=":-)" id="'+c+'_||_face_grin" src="images/tango/smiles/face-grin.png" alt="face-grin" /></li><li><img class="emoButton" title=":(" id="'+c+'_||_face_sad" src="images/tango/smiles/face-sad.png" alt="face-sad" /></li><li><img class="emoButton" title=":)" id="'+c+'_||_face_smile" src="images/tango/smiles/face-smile.png" alt="face-smile" /></li><li><img class="emoButton" title="0-)" id="'+c+'_||_face_surprise" src="images/tango/smiles/face-surprise.png" alt="face-surprise" /></li><li><img class="emoButton" title=";)" id="'+c+'_||_face_wink" src="images/tango/smiles/face-wink.png" alt="face-wink" /></li></ul><textarea id="'+c+'Input" class="chatInput" rows="4"></textarea></div>';$("div#"+c+".ui-tabs-panel").append(b);$("textarea#"+c+"Input.chatInput").focus();$(".emoButton").bind("click",{username:c},miaChat.emoClicked);$("#"+c+"-close").bind("click",{username:c},miaChat.chatClose);$("#"+c+"Input").bind("keyup",function(d){if(d.keyCode===13){miaChat.chatSubmit();miaChat.resetDocumentTitle("")}})}else{if((c!==$(".ui-tabs-selected > a > span").text())&&(!a)){$(".first > ul > li > a > span").each(function(d){if((d!==0)&&($(this).text()===c)){$(this).attr({"class":"blinker"});$(this).bind("click",function(){$(this).removeAttr("class");miaChat.resetDocumentTitle("")})}})}}miaChat.getChatTabs().tabs("select","#"+c);$("textarea#"+c+"Input.chatInput").focus(function(){$("#activeChat").attr({value:c})});$("textarea#"+c+"Input.chatInput").click(function(){miaChat.resetDocumentTitle("")});$("textarea#"+c+"Input.chatInput").focus()},removeBuddyFromList:function(a){$("#buddy"+a).remove()},emoClicked:function(){var b=this.id,a=b.split("_||_"),d=a[0]+"Input",c;c=$("#"+d).val();$("#"+d).attr("value",c+this.title);$("textarea#"+d+".chatInput").focus()},resetDocumentTitle:function(a){if(a===""){top.document.title="Mia-Chat"}else{top.document.title=a}}}}();$(document).ready(function(){miaChat.init();$("#chat-splitter").splitter({type:"v",outline:false,minLeft:300,minRight:250,sizeRight:250,resizeToWidth:true,cookie:"miachat-vsplitter",accessKey:"I"});$("a.greybox").click(function(){var a=this.title||$(this).text()||this.href;GB_show(a,this.href,400,600);return false});$("#uStatus").change(function(){var a=$("#uStatus option:selected").val();$.ajax({type:"POST",url:"updateStatus.php",data:"ustatus="+a})});$(".showoffline").change(function(){var a=$("input[name=showoffline]:checked").val();$.ajax({type:"POST",url:"updatePreferences.php",data:"showoffline="+a,success:function(){$("#buddylist").empty();miaChat.getBuddies()}})});$("#userPreferences").hide();$("#preferences").bind("click",{},function(){$("#userPreferences").slideToggle("slow")});$.timer(7500,function(){$.getJSON("getMessages.php",function(a){$.each(a,function(f,g){var c=a[f].mid,e=a[f].username_to,d=a[f].username_from,h=a[f].rand_insert_key,b,j;miaChat.startChat(d,false);miaChat.resetDocumentTitle("from "+d+" a message you got");b='<ul><li class="messageHeaderFriend">'+d+" ("+a[f].sent_date_time+')</li><li class="messageBodyFriend">'+a[f].message+"</li></ul>";j=d+"Input";$("#"+d+"Inner").append(b);$("#"+d+"Inner ul li.messageBodyFriend a").attr("target","_blank");miaChat.scrollToBottom(d+"Inner")})})});$.timer(15000,function(){miaChat.getBuddies()});$.timer(10000,function(){$.post("doHeartbeat.php")})});